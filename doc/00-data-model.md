## Data model — v0.0.1 (2025-10-26)

## Source & scope
- Source: live Neon DB configured in `.env.local` (see `DATABASE_URL`) + app types in `src/types/index.ts` and SQL helper scripts.
- Scope: concise, production-minded view of the current schema and small improvements recommended for a real-estate product.

## What this file contains
- High-level description of the current logical model and recommended production improvements.
- A short, generated snapshot of the actual schema (see "Current schema snapshot" below). For a full machine-readable dump see `doc/schema-introspection.json` (generated by `scripts/introspect-schema.js`).

## Design goals for improvements
- Normalize lookups (use FK integer ids) instead of free text for core enumerations (type, status).
- Use stable PKs (UUID) for public-facing entities (properties, media) and integer PKs for internal catalogs.
- Add explicit FK constraints, useful indexes, and audit timestamps. Keep geolocation typed and indexed for spatial queries.

## Key tables (recommended / conceptual)
- properties (public-facing): UUID PK, title, description, price (NUMERIC), currency, address, city/state/country/zip, property_type_id (FK), bedrooms, bathrooms, square_meters, year_built, seller reference, operation_status_id, property_status_id, geocode JSONB, latitude/longitude, published_at, created_at, updated_at.
- property_images: integer PK, property_id (UUID FK), image metadata (url, storage_key/blob_path, mime, size), is_cover, display_order, created_at, updated_at.
- property_media: UUID PK, property_id UUID, type, url/storage_key, metadata, uploaded_at.
- property_types, property_statuses, property_operation_statuses: small lookup tables with integer PKs.
- property_features + property_feature_assignments: feature catalog and many-to-many join table.
- neighborhoods: basic metadata for neighborhoods.
- user_saved_properties: user_id (string), property_id (UUID), saved_at, is_favorite, notes.

## Current schema snapshot (generated)
Below is a concise summary of the live schema discovered by `scripts/introspect-schema.js` (see `doc/schema-introspection.json` for a complete dump).

- Tables found (11): media_types, neighborhoods, properties, property_feature_assignments, property_features, property_images, property_media, property_operation_statuses, property_statuses, property_types, user_saved_properties.

- Representative columns and primary keys (short):
  - properties (PK: id UUID gen_random_uuid()) — title TEXT, description TEXT, price NUMERIC, address TEXT, city/state/country/zip_code, type TEXT (free text), room INTEGER, bathrooms INTEGER, status TEXT DEFAULT 'available', seller_id TEXT, operation_status_id INTEGER, geocode JSONB, latitude/longitude NUMERIC, created_at/updated_at, square_meters INTEGER
  - property_images (PK: id SERIAL) — property_id UUID, image_url VARCHAR(500), is_cover BOOLEAN, display_order INTEGER, blob_path, file_size, mime_type, original_filename, alt_text
  - property_media (PK: id UUID gen_random_uuid()) — property_id UUID, media_type TEXT, url TEXT, storage_key TEXT, file_name, file_size, mime_type, is_primary BOOLEAN, uploaded_at
  - property_types / property_statuses / property_operation_statuses (PK: id SERIAL) — simple lookup tables
  - property_features (PK: id SERIAL) — name, category, description, icon
  - property_feature_assignments (PK: id SERIAL) — property_id UUID, feature_id INTEGER, created_at
  - neighborhoods (PK: id SERIAL) — name, city, state, country, safety_rating, walkability_score, created_at/updated_at
  - user_saved_properties (PK: id SERIAL) — user_id VARCHAR, property_id UUID, saved_at, is_favorite, notes, updated_at

Notes from the snapshot:
- The `properties.type` and `properties.status` fields are stored as free text in the DB (not FK references).
- `properties.id` is a UUID in the DB, but application TypeScript types in `src/types/index.ts` declare `Property.id` as a number — this is an important mismatch to resolve.
- Several tables use integer serial PKs for catalogs and features while public entities (properties, property_media) use UUIDs — this is a good pattern but requires consistent typing in the app.
- There are currently no explicit FK constraints in the introspected relationships (most foreign columns are present but not enforced by FK constraints in the DB). Adding constraints is recommended.

## Suggested production improvements (short)
- Add FK constraints for all implicit relations (property_type_id, property_status_id, property_media.property_id, property_images.property_id).
- Normalize `properties.type` and `properties.status` into `property_types` and `property_statuses` as FK integer references.
- Fix TypeScript types to match DB types (IDs: string for UUIDs or change DB to int where appropriate). Update `src/types/index.ts`.
- Create GIN full-text index on title + description: `CREATE INDEX ON properties USING GIN (to_tsvector('english', coalesce(title,'') || ' ' || coalesce(description,'')));`
- Add GiST/BRIN or PostGIS for spatial queries on latitude/longitude.
- Add `published_at`, `is_listed` flags and a `listings_history` table to track price/status changes.

## How to reproduce the schema snapshot
- Ensure `.env.local` contains `DATABASE_URL` for the Neon DB.
- Run: `node scripts/introspect-schema.js > doc/schema-introspection.json`.

## Next steps (recommended)
- Produce CREATE TABLE DDL and explicit FK constraints from the `doc/schema-introspection.json` output.
- Generate a mermaid ER diagram from the JSON (small script can convert relationships to mermaid syntax).
- Start with a non-destructive migration to add lookup tables and indexes, then backfill and add FK constraints in a second safe migration.

End of file

